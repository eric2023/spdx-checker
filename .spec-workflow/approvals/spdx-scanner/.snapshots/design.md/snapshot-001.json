{
  "id": "snapshot_1761222881511_l6heoe4gk",
  "approvalId": "approval_1761222881508_605ezrje5",
  "approvalTitle": "SPDX Scanner Tool Design Specification",
  "version": 1,
  "timestamp": "2025-10-23T12:34:41.511Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis document describes the technical design for the SPDX License Declaration Scanner Tool. The tool will be implemented as a command-line application with a modular architecture that can scan source code files, detect and validate SPDX license declarations, and automatically correct or complete missing license information according to UnionTech's open source code declaration requirements and SPDX specification standards.\n\nThe design follows a pipeline architecture where files flow through scanning, parsing, validation, correction, and reporting phases, with each phase being independently testable and configurable.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\nSince this is a new project, we'll establish technical standards:\n- **Language**: Python 3.8+ for cross-platform compatibility and rich ecosystem\n- **Architecture**: Modular, plugin-based design with clear separation of concerns\n- **Standards**: Follow SPDX specification v2.2+, PEP 8 style guidelines\n- **Dependencies**: Minimize external dependencies, use standard library where possible\n\n### Project Structure (structure.md)\nThe implementation will follow a clean architecture pattern:\n```\nspdx-scanner/\n├── src/\n│   ├── scanner/        # File discovery and reading\n│   ├── parser/         # SPDX declaration parsing\n│   ├── validator/      # SPDX syntax and semantic validation\n│   ├── corrector/      # License declaration correction\n│   ├── reporter/       # Report generation and output\n│   ├── config/         # Configuration management\n│   ├── models/         # Data models and types\n│   ├── utils/          # Utility functions\n│   └── cli/            # Command-line interface\n├── tests/              # Comprehensive test suite\n├── templates/          # License header templates\n├── docs/               # Documentation\n└── examples/           # Usage examples\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **Python Standard Library**: `argparse`, `pathlib`, `re`, `json`, `concurrent.futures`\n- **SPDX Tools**: Existing SPDX Python libraries for validation (optional dependency)\n- **Template Engine**: Jinja2 for customizable license headers (optional)\n\n### Integration Points\n- **Git Hooks**: Pre-commit integration for automated checking\n- **CI/CD Systems**: Exit codes and machine-readable reports for automation\n- **IDE Plugins**: Future integration with popular development environments\n\n## Architecture\n\nThe tool follows a pipeline architecture with these core components:\n\n```mermaid\ngraph TD\n    A[CLI Interface] --> B[Configuration Manager]\n    B --> C[File Scanner]\n    C --> D[SPDX Parser]\n    D --> E[Validator]\n    E --> F{Valid?}\n    F -->|Yes| G[Reporter]\n    F -->|No| H[Corrector]\n    H --> G\n    G --> I[Output Generator]\n\n    J[Template Manager] --> H\n    K[License Database] --> E\n\n    style A fill:#e1f5e1\n    style G fill:#fff4e6\n    style I fill:#e1f5e1\n```\n\n### Modular Design Principles\n- **Single File Responsibility**: Each module handles one specific aspect (scanning, parsing, validation, etc.)\n- **Component Isolation**: Core logic separated from CLI interface for library usage\n- **Service Layer Separation**: Clear boundaries between data processing, business logic, and presentation\n- **Utility Modularity**: Helper functions grouped by functionality (file operations, SPDX handling, etc.)\n\n## Components and Interfaces\n\n### Component 1: File Scanner\n- **Purpose**: Discover and read source code files based on configuration\n- **Interfaces**:\n  - `scan_directory(path, patterns) -> List[FileInfo]`\n  - `read_file_info(filepath) -> FileInfo`\n- **Dependencies**: `pathlib`, `glob`, `mimetypes`\n- **Reuses**: Standard Python file handling utilities\n\n### Component 2: SPDX Parser\n- **Purpose**: Extract and parse SPDX license declarations from source files\n- **Interfaces**:\n  - `parse_spdx_declarations(content) -> SPDXInfo`\n  - `extract_license_header(content) -> str`\n- **Dependencies**: `re` (regex), custom SPDX grammar definitions\n- **Reuses**: Language-specific comment parsing patterns\n\n### Component 3: Validator\n- **Purpose**: Validate SPDX declarations for syntax and semantic correctness\n- **Interfaces**:\n  - `validate_spdx_info(spdx_info) -> ValidationResult`\n  - `check_license_compatibility(license_id) -> bool`\n- **Dependencies**: SPDX license database, validation rules\n- **Reuses**: SPDX specification validation logic\n\n### Component 4: Corrector\n- **Purpose**: Fix or complete missing SPDX license declarations\n- **Interfaces**:\n  - `correct_file(file_info, correction_rules) -> CorrectionResult`\n  - `generate_license_header(template, context) -> str`\n- **Dependencies**: Template engine, correction rules engine\n- **Reuses**: Language-specific formatting rules\n\n### Component 5: Reporter\n- **Purpose**: Generate reports in various formats\n- **Interfaces**:\n  - `generate_report(results, format) -> Report`\n  - `format_output(report, output_type) -> str`\n- **Dependencies**: JSON, HTML, Markdown formatters\n- **Reuses**: Existing reporting libraries (optional)\n\n## Data Models\n\n### SPDXInfo\n```python\n@dataclass\nclass SPDXInfo:\n    license_identifier: Optional[str]\n    copyright_text: Optional[str]\n    project_attribution: Optional[str]\n    spdx_version: Optional[str]\n    validation_errors: List[str]\n    declaration_type: str  # 'header', 'inline', 'separate'\n```\n\n### FileInfo\n```python\n@dataclass\nclass FileInfo:\n    filepath: Path\n    language: str\n    content: str\n    encoding: str\n    line_endings: str\n    has_shebang: bool\n    spdx_info: Optional[SPDXInfo]\n```\n\n### ValidationResult\n```python\n@dataclass\nclass ValidationResult:\n    is_valid: bool\n    errors: List[ValidationError]\n    warnings: List[ValidationWarning]\n    suggestions: List[str]\n```\n\n### CorrectionResult\n```python\n@dataclass\nclass CorrectionResult:\n    original_content: str\n    corrected_content: str\n    changes_made: List[str]\n    backup_created: bool\n    success: bool\n    error_message: Optional[str]\n```\n\n## Error Handling\n\n### Error Scenarios\n1. **File Access Errors**: Permission denied, file not found\n   - **Handling**: Log error, skip file, continue processing\n   - **User Impact**: Warning in report indicating which files couldn't be processed\n\n2. **Invalid SPDX Syntax**: Malformed license identifiers, incorrect format\n   - **Handling**: Mark as validation error, attempt correction if possible\n   - **User Impact**: Detailed error message with line number and correction suggestion\n\n3. **Template Rendering Errors**: Missing template variables, template syntax errors\n   - **Handling**: Fall back to default template, log error\n   - **User Impact**: Warning about template issue, uses safe defaults\n\n4. **Configuration Errors**: Invalid settings, missing required parameters\n   - **Handling**: Validate configuration on startup, provide clear error messages\n   - **User Impact**: Immediate feedback with specific configuration issues\n\n## Testing Strategy\n\n### Unit Testing\n- Test each component in isolation with mocked dependencies\n- Focus on edge cases (empty files, malformed SPDX, various languages)\n- Test configuration validation and error handling\n- Achieve >90% code coverage for core logic\n\n### Integration Testing\n- Test complete pipeline from CLI to report generation\n- Test with real-world codebases of various sizes\n- Verify cross-platform compatibility (Windows, macOS, Linux)\n- Test Git hook integration scenarios\n\n### End-to-End Testing\n- Create test repositories with known SPDX issues\n- Verify tool correctly identifies and fixes all issues\n- Test report generation and formatting\n- Validate performance with large codebases (10k+ files)",
  "fileStats": {
    "size": 7755,
    "lines": 208,
    "lastModified": "2025-10-23T12:33:11.109Z"
  },
  "comments": []
}